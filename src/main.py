import os
import sys
from src.providers.rootdata import RootDataClient
from src.senders.email_sender import send_email
from src.export_excel import save_to_excel
from src.summarize import generate_market_analysis

def main():
    print(">>> [1/4] å¼€å§‹æŠ“å–æ•°æ®...")
    # åˆå§‹åŒ–å®¢æˆ·ç«¯
    client = RootDataClient()
    
    # æŠ“å–æ•°æ®
    fund = client.fetch_fundraising()
    air = client.fetch_airdrops()
    eco = client.fetch_ecosystem()
    unl = client.fetch_token_unlocks()
    
    print(f"    - èèµ„: {len(fund)} | ç©ºæŠ•: {len(air)} | è§£é”: {len(unl)}")

    print(">>> [2/4] ç”Ÿæˆåˆ†æç®€æŠ¥...")
    # è°ƒç”¨è§„åˆ™å¼•æ“ç”Ÿæˆ HTML
    summary_html = generate_market_analysis(fund, air, unl, eco)

    print(">>> [3/4] ç”Ÿæˆ Excel é™„ä»¶...")
    excel_path = save_to_excel({
        "1.èèµ„äº‹ä»¶": fund,
        "2.æ½œåœ¨ç©ºæŠ•": air,
        "3.ä»£å¸è§£é”": unl,
        "4.ç”Ÿæ€å˜åŒ–": eco
    })

    print(">>> [4/4] å‘é€é‚®ä»¶...")
    email_body = f"""
    <h2>Web3 æ¯æ—¥æŠ•ç ”ç®€æŠ¥</h2>
    <div style="background-color: #f9f9f9; padding: 15px; border-left: 4px solid #0366d6;">
        {summary_html}
    </div>
    <p style="margin-top: 20px;">ğŸ“ <b>è¯¦ç»†æ•°æ®è¯·æŸ¥çœ‹é™„ä»¶ Excel è¡¨æ ¼ã€‚</b></p>
    <hr>
    <small>Generated by GitHub Actions</small>
    """
    
    attachments = [excel_path] if excel_path else []
    
    try:
        send_email(
            subject=f"ğŸš€ Web3 æ—¥æŠ¥: èèµ„{len(fund)}èµ· | ç©ºæŠ•{len(air)}ä¸ª",
            body=email_body,
            env=os.environ,
            attachments=attachments
        )
        print("âœ… ä»»åŠ¡æˆåŠŸå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()

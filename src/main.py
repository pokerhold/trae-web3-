import os
import sys
from src.providers.rootdata import RootDataClient
from src.providers.coingecko import CoinGeckoClient  # <--- å¯¼å…¥æ–°æ¨¡å—
from src.senders.email_sender import send_email
from src.export_excel import save_to_excel
from src.summarize import generate_market_analysis

def main():
    print(">>> [1/4] å¼€å§‹æŠ“å–æ•°æ®...")
    
    # 1. æŠ“å– RootData
    rd_client = RootDataClient()
    fund = rd_client.fetch_fundraising()
    air = rd_client.fetch_airdrops()
    eco = rd_client.fetch_ecosystem()
    unl = rd_client.fetch_token_unlocks()
    
    # 2. æŠ“å– CoinGecko (æ–°å¢)
    cg_client = CoinGeckoClient()
    markets = cg_client.fetch_market_data(limit=30) # æŠ“å‰30å
    
    print(f"    - èèµ„: {len(fund)} | è¡Œæƒ…: {len(markets)} ä¸ªä»£å¸")

    print(">>> [2/4] ç”Ÿæˆåˆ†æç®€æŠ¥...")
    # ä¼ å…¥ markets æ•°æ®
    summary_html = generate_market_analysis(fund, air, unl, eco, markets)

    print(">>> [3/4] ç”Ÿæˆ Excel é™„ä»¶...")
    excel_path = save_to_excel({
        "0.å¸‚åœºè¡Œæƒ…": markets,  # <--- æ”¾åœ¨ç¬¬ä¸€ä¸ªè¡¨
        "1.èèµ„äº‹ä»¶": fund,
        "2.æ½œåœ¨ç©ºæŠ•": air,
        "3.ä»£å¸è§£é”": unl,
        "4.ç”Ÿæ€å˜åŒ–": eco
    })

    print(">>> [4/4] å‘é€é‚®ä»¶...")
    email_body = f"""
    <h2>Web3 æ¯æ—¥æŠ•ç ”ç®€æŠ¥</h2>
    <div style="background-color: #f9f9f9; padding: 15px; border-left: 4px solid #0366d6;">
        {summary_html}
    </div>
    <p style="margin-top: 20px;">ğŸ“ <b>è¯¦ç»†è¡Œæƒ…ä¸æ•°æ®è¯·æŸ¥çœ‹é™„ä»¶ Excel è¡¨æ ¼ã€‚</b></p>
    <hr>
    <small>Generated by GitHub Actions</small>
    """
    
    attachments = [excel_path] if excel_path else []
    
    try:
        send_email(
            subject=f"ğŸš€ Web3 æ—¥æŠ¥: BTCè¡Œæƒ… & èèµ„{len(fund)}èµ·",
            body=email_body,
            env=os.environ,
            attachments=attachments
        )
        print("âœ… ä»»åŠ¡æˆåŠŸå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()

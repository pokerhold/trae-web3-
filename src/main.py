import os
import sys
from src.providers.rootdata import RootDataClient
from src.providers.coingecko import CoinGeckoClient
from src.providers.cryptopanic import CryptoPanicClient # <--- å¯¼å…¥æ–°æ¨¡å—
from src.senders.email_sender import send_email
from src.export_excel import save_to_excel
from src.summarize import generate_market_analysis

def main():
    print(">>> [1/5] å¯åŠ¨æŠ“å–ä»»åŠ¡...")
    
    # 1. RootData
    rd = RootDataClient()
    fund = rd.fetch_fundraising()
    air = rd.fetch_airdrops()
    eco = rd.fetch_ecosystem()
    unl = rd.fetch_token_unlocks()
    
    # 2. CoinGecko
    cg = CoinGeckoClient()
    markets = cg.fetch_market_data(limit=30)
    
    # 3. CryptoPanic (æ–°å¢)
    # ä»ç¯å¢ƒå˜é‡è·å– Key
    cp_key = os.getenv("CRYPTOPANIC_API_KEY", "")
    cp = CryptoPanicClient(api_key=cp_key)
    news = cp.fetch_hot_news(limit=20)
    
    print(f"    - èèµ„:{len(fund)} | è¡Œæƒ…:{len(markets)} | æ–°é—»:{len(news)}")

    print(">>> [2/5] ç”Ÿæˆåˆ†æç®€æŠ¥...")
    # ä¼ å…¥ news æ•°æ®
    summary_html = generate_market_analysis(fund, air, unl, eco, markets, news)

    print(">>> [3/5] ç”Ÿæˆ Excel é™„ä»¶...")
    excel_path = save_to_excel({
        "0.å¸‚åœºè¡Œæƒ…": markets,
        "1.èˆ†æƒ…çƒ­ç‚¹": news,  # <--- æ–°å¢ Sheet
        "2.èèµ„äº‹ä»¶": fund,
        "3.æ½œåœ¨ç©ºæŠ•": air,
        "4.ä»£å¸è§£é”": unl,
        "5.ç”Ÿæ€å˜åŒ–": eco
    })

    print(">>> [4/5] å‘é€é‚®ä»¶...")
    email_body = f"""
    <h2>Web3 æ¯æ—¥æŠ•ç ”ç®€æŠ¥</h2>
    <div style="background-color: #f9f9f9; padding: 15px; border-left: 4px solid #0366d6;">
        {summary_html}
    </div>
    <p style="margin-top: 20px;">ğŸ“ <b>è¯¦ç»†æ•°æ®è¯·æŸ¥çœ‹é™„ä»¶ Excel è¡¨æ ¼ã€‚</b></p>
    <hr>
    <small>Generated by GitHub Actions</small>
    """
    
    attachments = [excel_path] if excel_path else []
    
    try:
        send_email(
            subject=f"ğŸš€ Web3 æ—¥æŠ¥: {len(news)}æ¡çƒ­ç‚¹ | èèµ„{len(fund)}èµ·",
            body=email_body,
            env=os.environ,
            attachments=attachments
        )
        print("âœ… ä»»åŠ¡æˆåŠŸå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
import os
import sys
from src.providers.rootdata import RootDataClient
from src.providers.coingecko import CoinGeckoClient
from src.providers.cryptopanic import CryptoPanicClient
from src.senders.email_sender import send_email
# from src.export_excel import save_to_excel  <-- åˆ æ‰æˆ–æ³¨é‡Šè¿™è¡Œ
from src.export_html import save_to_html     # <-- å¢åŠ è¿™è¡Œ
from src.summarize import generate_market_analysis

def main():
    # ... (å‰é¢çš„æŠ“å–ä»£ç ä¸ç”¨åŠ¨) ...
    # ... ç›´åˆ° "[2/5] ç”Ÿæˆåˆ†æç®€æŠ¥..." ä¹Ÿä¸ç”¨åŠ¨ ...
    
    # --- ä¿®æ”¹è¿™éƒ¨åˆ† ---
    print(">>> [3/5] ç”Ÿæˆ HTML æŠ¥å‘Šé™„ä»¶...")
    # ä½¿ç”¨æ–°çš„ save_to_html å‡½æ•°
    report_path = save_to_html({
        "0.å¸‚åœºè¡Œæƒ…": markets,
        "1.èˆ†æƒ…çƒ­ç‚¹": news,
        "2.èèµ„äº‹ä»¶": fund,
        "3.æ½œåœ¨ç©ºæŠ•": air,
        "4.ä»£å¸è§£é”": unl,
        "5.ç”Ÿæ€å˜åŒ–": eco
    })
    # ----------------

    print(">>> [4/5] å‘é€é‚®ä»¶...")
    # é‚®ä»¶æ­£æ–‡ä¿æŒä¸å˜
    email_body = f"""
    <h2>Web3 æ¯æ—¥æŠ•ç ”ç®€æŠ¥</h2>
    <div style="background-color: #f9f9f9; padding: 15px; border-left: 4px solid #0366d6;">
        {summary_html}
    </div>
    <p style="margin-top: 20px;">ğŸ“ <b>å®Œæ•´äº¤äº’å¼æ•°æ®è¯·æŸ¥çœ‹é™„ä»¶ HTML æ–‡ä»¶ (æ¨èç”¨æµè§ˆå™¨æ‰“å¼€)ã€‚</b></p>
    <hr>
    <small>Generated by GitHub Actions</small>
    """
    
    attachments = [report_path] if report_path else []
    
    try:
        send_email(
            subject=f"ğŸš€ Web3 æ—¥æŠ¥: {len(news)}æ¡çƒ­ç‚¹ | èèµ„{len(fund)}èµ·",
            body=email_body,
            env=os.environ,
            attachments=attachments
        )
        print("âœ… ä»»åŠ¡æˆåŠŸå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()